<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>åœ¨çº¿å•†åŸç³»ç»Ÿ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2 { border-bottom: 2px solid #ddd; padding-bottom: 10px; color: #333; }

        /* ç™»å½• & æ³¨å†Œ */
        #login-box, #register-box { text-align: center; margin-top: 50px; }
        input, select, textarea { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 5px; width: 200px; }
        textarea { width: 80%; height: 60px; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #0056b3; }
        button.red { background-color: #dc3545; }
        button.green { background-color: #28a745; }
        button.orange { background-color: #fd7e14; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .link-btn { background: none; color: #007bff; text-decoration: underline; padding: 5px; font-size: 14px; }

        /* å•†å“åˆ—è¡¨ */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .product-card { border: 1px solid #eee; padding: 15px; border-radius: 8px; text-align: center; transition: 0.3s; }
        .product-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .price { color: #e65100; font-weight: bold; font-size: 1.2em; }

        /* è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 14px; }
        th { background-color: #f8f9fa; }

        /* é€šç”¨ç±» */
        .hidden { display: none; }
        .section { margin-bottom: 40px; border: 1px solid #f1f1f1; padding: 15px; border-radius: 8px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }

        /* åˆ†é¡µæ§ä»¶æ ·å¼ */
        .pagination-bar { margin-top: 15px; text-align: right; }
        .pagination-bar span { margin: 0 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">

    <div id="top-bar" class="header hidden">
        <div>ğŸ‘¤ å½“å‰ç”¨æˆ·: <span id="current-user" style="font-weight:bold"></span></div>
        <button class="red" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>

    <div id="login-box">
        <h1>ğŸ¬ Karlçš„åœ¨çº¿ç‚¸é¸¡åº—</h1>
        <div style="margin-bottom: 20px; color: #666; font-size: 14px;">ç®¡ç†å‘˜ä¸æ™®é€šç”¨æˆ·å…±ç”¨å¹³å°</div>
        <input type="text" id="username" placeholder="ç”¨æˆ·å">
        <input type="password" id="password" placeholder="å¯†ç ">
        <br>
        <button onclick="login()">ç™»å½•</button>
        <br>
        <button class="link-btn" onclick="toggleAuth('register')">æ²¡æœ‰è´¦å·ï¼Ÿç‚¹æ­¤æ³¨å†Œ</button>
    </div>

    <div id="register-box" class="hidden">
        <h1>ğŸ†• æ–°ç”¨æˆ·æ³¨å†Œ</h1>
        <div style="margin-bottom: 10px; color: #666; font-size: 14px;">è¯·å¡«å†™é‚®ç®±ä»¥æ¥æ”¶å‘è´§é€šçŸ¥</div>
        <input type="text" id="reg-username" placeholder="ç”¨æˆ·å (å¿…å¡«)">
        <input type="text" id="reg-name" placeholder="æ˜µç§°/å§“å">
        <input type="text" id="reg-email" placeholder="ç”µå­é‚®ç®± (å¦‚ xxx@qq.com)">
        <input type="password" id="reg-password" placeholder="è®¾ç½®å¯†ç  (å¿…å¡«)">
        <br>
        <button class="green" onclick="register()">ç«‹å³æ³¨å†Œ</button>
        <br>
        <button class="link-btn" onclick="toggleAuth('login')">å·²æœ‰è´¦å·ï¼Ÿè¿”å›ç™»å½•</button>
    </div>

    <div id="customer-app" class="hidden">
        <h2>ğŸ›ï¸ å•†å“é€‰è´­</h2>
        <div class="product-grid" id="product-list"></div>

        <div class="section">
            <h3>ğŸ›’ æˆ‘çš„è´­ç‰©è½¦</h3>
            <table id="cart-table">
                <thead><tr><th>å•†å“</th><th>å•ä»·</th><th>æ•°é‡</th><th>å°è®¡</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="cart-body"></tbody>
            </table>
            <div style="text-align: right; margin-top: 10px;">
                <button class="green" onclick="checkout()">ä¸€é”®ç»“è´¦ä¸‹å•</button>
            </div>
        </div>

        <div class="section">
            <h3>ğŸ§¾ æˆ‘çš„å†å²è®¢å•</h3>
            <button onclick="loadMyOrders()">åˆ·æ–°åˆ—è¡¨</button>
            <table>
                <thead><tr><th>è®¢å•å·</th><th>å•†å“</th><th>æ•°é‡</th><th>æ€»ä»·</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="my-order-body"></tbody>
            </table>
        </div>
    </div>

    <div id="admin-app" class="hidden">
        <div class="section">
            <h3>â• å•†å“ç®¡ç†</h3>
            <input type="text" id="p-name" placeholder="å•†å“åç§°">
            <input type="number" id="p-price" placeholder="ä»·æ ¼">
            <input type="number" id="p-stock" placeholder="åº“å­˜">
            <input type="text" id="p-image" placeholder="å›¾ç‰‡å">
            <br><textarea id="p-desc" placeholder="å•†å“æè¿°"></textarea><br>
            <button class="green" onclick="addProduct()">ä¸Šæ¶å•†å“</button>
        </div>

        <div class="section">
            <h3>ğŸ“¦ è®¢å•ç®¡ç† (å‘è´§)</h3>
            <button class="orange" onclick="loadAllOrders()">åˆ·æ–°æ‰€æœ‰è®¢å•</button>

            <table>
                <thead><tr><th>è®¢å•å·</th><th>ç”¨æˆ·ID</th><th>å•†å“</th><th>æ•°é‡</th><th>æ€»ä»·</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="admin-order-body"></tbody>
            </table>

            <div class="pagination-bar">
                <button id="btn-prev" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
                <span id="page-info">ç¬¬ 1 é¡µ</span>
                <button id="btn-next" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>

        <div class="section">
            <h3>ğŸ“ˆ é”€å”®ç»Ÿè®¡æŠ¥è¡¨ (Dashboard)</h3>
            <button class="orange" onclick="loadStats()">æŸ¥çœ‹è¥æ”¶æƒ…å†µ</button>
            <table style="margin-top:10px">
                <thead>
                <tr style="background:#fff3cd">
                    <th>å•†å“åç§°</th>
                    <th>ç´¯è®¡é”€é‡ (ä»½)</th>
                    <th>ç´¯è®¡æ”¶å…¥ (å…ƒ)</th>
                </tr>
                </thead>
                <tbody id="stats-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080";

    // å…¨å±€å˜é‡
    let currentUserId = null;
    let currentUserRole = 0;

    // åˆ†é¡µå˜é‡
    let allAdminOrders = [];
    let currentPage = 1;
    const pageSize = 5;

    // è‡ªåŠ¨ç™»å½•
    window.onload = function() {
        const savedUser = localStorage.getItem('shop_user');
        if (savedUser) {
            handleLoginSuccess(JSON.parse(savedUser));
        }
    }

    function toggleAuth(mode) {
        if(mode === 'register') {
            document.getElementById('login-box').classList.add('hidden');
            document.getElementById('register-box').classList.remove('hidden');
        } else {
            document.getElementById('register-box').classList.add('hidden');
            document.getElementById('login-box').classList.remove('hidden');
        }
    }

    async function register() {
        const username = document.getElementById('reg-username').value;
        const name = document.getElementById('reg-name').value;
        const password = document.getElementById('reg-password').value;
        const email = document.getElementById('reg-email').value;

        if(!username || !password) { alert("ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼"); return; }

        const res = await fetch(`${API_BASE}/user/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password, name, email })
        });
        const result = await res.json();
        if (result.code === 1) {
            alert("âœ… æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•");
            toggleAuth('login');
        } else {
            alert("âŒ æ³¨å†Œå¤±è´¥: " + result.msg);
        }
    }

    async function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        const res = await fetch(`${API_BASE}/user/login`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        const result = await res.json();

        if (result.code === 1) {
            localStorage.setItem('shop_user', JSON.stringify(result.data));
            handleLoginSuccess(result.data);
        } else {
            alert("ç™»å½•å¤±è´¥: " + result.msg);
        }
    }

    function handleLoginSuccess(user) {
        currentUserId = user.id;
        currentUserRole = user.role;
        const roleName = currentUserRole === 1 ? 'ç®¡ç†å‘˜' : 'é¡¾å®¢';

        document.getElementById('current-user').innerText = `${user.name} (${roleName})`;
        document.getElementById('login-box').classList.add('hidden');
        document.getElementById('register-box').classList.add('hidden');
        document.getElementById('top-bar').classList.remove('hidden'); // æ˜¾ç¤ºé¡¶éƒ¨æ (åŒ…å«é€€å‡ºæŒ‰é’®)

        if (currentUserRole === 1) {
            document.getElementById('admin-app').classList.remove('hidden');
            loadAllOrders();
        } else {
            document.getElementById('customer-app').classList.remove('hidden');
            loadProducts(); loadCart(); loadMyOrders();
        }
    }

    function logout() {
        localStorage.removeItem('shop_user');
        location.reload();
    }

    // ================= é¡¾å®¢åŠŸèƒ½ =================
    async function loadProducts() {
        const res = await fetch(`${API_BASE}/product/list`);
        const result = await res.json();
        const listDiv = document.getElementById('product-list');
        listDiv.innerHTML = '';
        result.data.forEach(p => {
            listDiv.innerHTML += `<div class="product-card"><h3>${p.name}</h3><p class="price">Â¥${p.price}</p><p style="font-size:12px;color:#888">åº“å­˜: ${p.stock}</p><button onclick="addToCart(${p.id})">åŠ å…¥</button></div>`;
        });
    }
    async function addToCart(pid) { await fetch(`${API_BASE}/cart/add`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:currentUserId,productId:pid,count:1})}); loadCart(); }
    async function loadCart() {
        const res = await fetch(`${API_BASE}/cart/list?userId=${currentUserId}`);
        const result = await res.json();
        const tbody = document.getElementById('cart-body');
        tbody.innerHTML = '';
        result.data.forEach(item => {
            tbody.innerHTML += `<tr><td>${item.productName}</td><td>${item.price}</td><td><button onclick="decrease(${item.id})">-</button> ${item.count} <button onclick="addToCart(${item.productId})">+</button></td><td>${item.totalMoney}</td><td><button class="red" onclick="removeFromCart(${item.id})">åˆ </button></td></tr>`;
        });
    }
    async function decrease(id) { await fetch(`${API_BASE}/cart/decrease?id=${id}`, {method:'POST'}); loadCart(); }
    async function removeFromCart(id) { await fetch(`${API_BASE}/cart/remove?id=${id}`, {method:'DELETE'}); loadCart(); }
    async function checkout() {
        if(!confirm("ç¡®å®šç»“ç®—å—ï¼Ÿ")) return;
        const res = await fetch(`${API_BASE}/order/checkout?userId=${currentUserId}`, {method:'POST'});
        const result = await res.json();
        if(result.code===1){alert(result.data);loadCart();loadMyOrders();}else{alert(result.msg);}
    }
    async function loadMyOrders() {
        const res = await fetch(`${API_BASE}/order/list?userId=${currentUserId}`);
        const result = await res.json();
        renderOrderRows(result.data, document.getElementById('my-order-body'), false);
    }
    async function payOrder(orderNo) {
        await fetch(`${API_BASE}/order/pay?orderNo=${orderNo}`, {method:'POST'});
        alert("æ”¯ä»˜æˆåŠŸ"); currentUserRole===1 ? loadAllOrders() : loadMyOrders();
    }

    // ================= ç®¡ç†å‘˜åŠŸèƒ½ =================

    async function addProduct() {
        const data = {name:document.getElementById('p-name').value,price:document.getElementById('p-price').value,stock:document.getElementById('p-stock').value,image:document.getElementById('p-image').value,description:document.getElementById('p-desc').value};
        const res = await fetch(`${API_BASE}/product/add`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        if((await res.json()).code===1) alert("ä¸Šæ¶æˆåŠŸï¼");
    }

    async function loadAllOrders() {
        const res = await fetch(`${API_BASE}/order/admin/list`);
        const result = await res.json();
        allAdminOrders = result.data;
        currentPage = 1;
        renderAdminPage();
    }

    function renderAdminPage() {
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageData = allAdminOrders.slice(start, end);

        const tbody = document.getElementById('admin-order-body');
        renderOrderRows(pageData, tbody, true);

        document.getElementById('page-info').innerText = `ç¬¬ ${currentPage} é¡µ / å…± ${Math.ceil(allAdminOrders.length / pageSize)} é¡µ`;
        document.getElementById('btn-prev').disabled = (currentPage === 1);
        document.getElementById('btn-next').disabled = (end >= allAdminOrders.length);
    }

    function changePage(delta) {
        currentPage += delta;
        renderAdminPage();
    }

    async function shipOrder(orderNo) {
        if(!confirm(`å‘è´§å¹¶å‘é€é‚®ä»¶ç»™è®¢å• ${orderNo} ï¼Ÿ`)) return;
        const res = await fetch(`${API_BASE}/order/ship?orderNo=${orderNo}`, {method:'POST'});
        if((await res.json()).code===1) { alert("å‘è´§æˆåŠŸï¼é‚®ä»¶å·²å‘é€ï¼"); loadAllOrders(); }
    }

    async function loadStats() {
        const res = await fetch(`${API_BASE}/order/admin/stats`);
        const result = await res.json();
        const tbody = document.getElementById('stats-body');
        tbody.innerHTML = '';

        let totalMoney = 0;

        if (result.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3">æš‚æ— é”€å”®æ•°æ®</td></tr>';
            return;
        }

        result.data.forEach(item => {
            totalMoney += item.totalRevenue;
            tbody.innerHTML += `
                <tr>
                    <td>${item.productName}</td>
                    <td style="font-weight:bold;color:#007bff">${item.totalSold}</td>
                    <td style="font-weight:bold;color:#28a745">Â¥ ${item.totalRevenue}</td>
                </tr>
            `;
        });

        tbody.innerHTML += `
            <tr style="background:#f8f9fa;font-weight:bold;border-top:2px solid #ddd">
                <td>ğŸ’° å…¨åº—æ€»è®¡</td>
                <td>-</td>
                <td style="color:#d32f2f;font-size:1.2em">Â¥ ${totalMoney.toFixed(2)}</td>
            </tr>
        `;
    }

    function renderOrderRows(orders, tbody, isAdmin) {
        tbody.innerHTML = '';
        if (orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7">æš‚æ— è®¢å•æ•°æ®</td></tr>';
            return;
        }

        orders.forEach(order => {
            let statusHtml = '';
            let actionBtn = '';

            if (order.status === 1) {
                statusHtml = '<span style="color:red;font-weight:bold">å¾…ä»˜æ¬¾</span>';
                if (isAdmin) {
                    actionBtn = '<span style="color:#999;font-size:12px">ç­‰å¾…ç”¨æˆ·ä»˜æ¬¾...</span>';
                } else {
                    actionBtn = `<button class="green" onclick="payOrder('${order.orderNo}')">æ¨¡æ‹Ÿæ”¯ä»˜</button>`;
                }
            } else if (order.status === 2) {
                statusHtml = '<span style="color:orange;font-weight:bold">å·²ä»˜æ¬¾ (å¾…å‘è´§)</span>';
                if (isAdmin) {
                    actionBtn = `<button class="orange" onclick="shipOrder('${order.orderNo}')">ç‚¹å‡»å‘è´§</button>`;
                } else {
                    actionBtn = 'ç­‰å¾…å‘è´§...';
                }
            } else if (order.status === 3) {
                statusHtml = '<span style="color:green;font-weight:bold">å·²å‘è´§</span>';
                actionBtn = 'âœ… äº¤æ˜“å®Œæˆ';
            }

            tbody.innerHTML += `
                <tr>
                    <td style="font-size:12px">${order.orderNo}</td>
                    ${isAdmin ? `<td style="color:#666">User:${order.userId}</td>` : ''}
                    <td>${order.productName}</td>
                    <td>${order.count}</td>
                    <td>${order.totalAmount}</td>
                    <td>${statusHtml}</td>
                    <td>${actionBtn}</td>
                </tr>
            `;
        });
    }
</script>

</body>
</html>